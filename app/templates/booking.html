{% extends "base.html" %}

{% block title %}Book {{ movie.title }} - CinemaMax{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-20">
    <div class="max-w-6xl mx-auto">
        <h1 class="section-title text-center mb-6">Book Tickets</h1>
        <p class="text-center text-gray-400 mb-16 text-xl">{{ movie.title }}</p>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Booking Form -->
            <div class="card-elegant p-8">
                <h2 class="text-2xl font-semibold mb-8 text-white">Select Showtime</h2>
                
                <form id="bookingForm">
                    <div class="mb-8">
                        <label class="form-label">Cinema</label>
                        <select id="cinemaSelect" class="form-input">
                            <option value="">Select Cinema</option>
                            {% for cinema in cinemas %}
                                <option value="{{ cinema.id }}">{{ cinema.name }} - {{ cinema.location }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-8">
                        <label class="form-label">Date & Time</label>
                        <select id="showtimeSelect" class="form-input">
                            <option value="">Select Showtime</option>
                            {% for showtime in showtimes %}
                                <option value="{{ showtime.id }}" data-cinema="{{ showtime.cinema_id }}" data-price="{{ movie.price }}">
                                    {{ showtime.show_date.strftime('%b %d, %Y') }} - {{ showtime.show_time.strftime('%I:%M %p') }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            
            <!-- Seat Selection -->
            <div class="card-elegant p-8">
                <h2 class="text-2xl font-semibold mb-8 text-white">Select Seats</h2>
                
                <!-- Screen -->
                <div class="text-center py-4 rounded-xl mb-8 font-bold text-black bg-gradient-to-r from-yellow-400 to-yellow-600">
                    SCREEN
                </div>
                
                <!-- Seat Grid -->
                <div id="seatGrid" class="grid grid-cols-10 gap-3 mb-8 justify-center">
                    <!-- Seats will be generated by JavaScript -->
                </div>
                
                <!-- Legend -->
                <div class="flex flex-wrap gap-4 text-sm mb-6">
                    <div class="flex items-center">
                        <div class="seat available w-4 h-4 mr-2"></div>
                        <span>Available</span>
                    </div>
                    <div class="flex items-center">
                        <div class="seat selected w-4 h-4 mr-2"></div>
                        <span>Selected</span>
                    </div>
                    <div class="flex items-center">
                        <div class="seat occupied w-4 h-4 mr-2"></div>
                        <span>Occupied</span>
                    </div>
                </div>
                
                <!-- Booking Summary -->
                <div id="bookingSummary" class="border-t border-gray-700 pt-8">
                    <div class="flex justify-between mb-2">
                        <span>Selected Seats:</span>
                        <span id="selectedSeats">-</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span>Price per ticket:</span>
                        <span>${{ "%.2f"|format(movie.price) }}</span>
                    </div>
                    <div class="flex justify-between mb-8 text-2xl font-bold">
                        <span>Total:</span>
                        <span id="totalPrice" class="text-yellow-400">$0.00</span>
                    </div>
                    
                    <button id="proceedToPayment" 
                            class="w-full btn-primary py-4 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        Proceed to Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function encryptString(e){const t="CinemaMaxSecretKey123";let r="";for(let n=0;n<e.length;n++){const s=e.charCodeAt(n)^t.charCodeAt(n%t.length);r+=String.fromCharCode(s)}return btoa(r)}function encryptPrice(e){return encryptString(e)}function encryptSeats(e){return encryptString(e)}let selectedSeats=[],ticketPrice={{movie.price}},currentShowtime=null;function generateSeatGrid(){const e=document.getElementById("seatGrid");e.innerHTML="";const t=["A","B","C","D","E"];for(let r=0;r<5;r++)for(let n=1;n<=10;n++){const s=t[r]+n,c=document.createElement("div");c.className="seat available",c.textContent=s,c.dataset.seatId=s,Math.random()<.15?(c.className="seat occupied",c.dataset.occupied="true"):c.addEventListener("click",toggleSeat),e.appendChild(c)}}function toggleSeat(e){const t=e.target,r=t.dataset.seatId;if(t.dataset.occupied)return;selectedSeats.includes(r)?(selectedSeats=selectedSeats.filter(e=>e!==r),t.className="seat available"):(selectedSeats.push(r),t.className="seat selected"),updateBookingSummary()}function updateBookingSummary(){document.getElementById("selectedSeats").textContent=selectedSeats.join(", ")||"-";const e=selectedSeats.length*ticketPrice;document.getElementById("totalPrice").textContent="$"+e.toFixed(2);const t=document.getElementById("proceedToPayment");selectedSeats.length>0&&currentShowtime?t.disabled=!1:t.disabled=!0}document.getElementById("showtimeSelect").addEventListener("change",function(e){currentShowtime=e.target.value,updateBookingSummary()}),document.getElementById("proceedToPayment").addEventListener("click",function(){if(0===selectedSeats.length||!currentShowtime)return;const e=(selectedSeats.length*ticketPrice).toFixed(2),t=encryptPrice(e.toString()),r=selectedSeats.join(","),n=encryptSeats(r),s=new URLSearchParams({showtime_id:currentShowtime,seats:n,total_price:t});window.location.href="/payment?"+s.toString()}),generateSeatGrid(),updateBookingSummary();
</script>

{% endblock %}
